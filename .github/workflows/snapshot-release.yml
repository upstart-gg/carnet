name: Snapshot Release

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "package.json"
      - "bun.lock"
      - ".changeset/**"

jobs:
  snapshot-release:
    # Only run if this is NOT a changeset release commit (to avoid duplicate releases)
    if: github.repository == 'upstart-gg/carnet' && !startsWith(github.event.head_commit.message, 'chore(release):')
    name: Snapshot Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".tool-versions"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Create snapshot version
        id: version
        run: |
          SHA=${{ github.sha }}
          SNAPSHOT_SHA="${SHA:0:7}"
          bun run version:packages -- --snapshot "$SNAPSHOT_SHA"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish snapshot to npm
        id: publish
        run: |
          OUTPUT=$(bun run publish:packages -- --tag next 2>&1)
          echo "$OUTPUT"
          echo "output=$OUTPUT" >> $GITHUB_OUTPUT
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Parse published packages
        id: parsed
        run: |
          OUTPUT='${{ steps.publish.outputs.output }}'
          # Extract package names and versions from npm output
          PACKAGES=$(echo "$OUTPUT" | grep -oP '@upstart-gg/\w+@[\d\.\-\w]+' || true)
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
        if: always()

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.parsed.outputs.packages != ''
        uses: actions/github-script@v7
        with:
          script: |
            const packages = '${{ steps.parsed.outputs.packages }}'.split('\n').filter(p => p.trim());
            if (packages.length === 0) return;

            const comment = `## Snapshot Release\n\nPublished snapshot releases:\n${packages.map(p => `- ${p}`).join('\n')}\n\nInstall with: \`npm install ${packages[0]}\``;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
